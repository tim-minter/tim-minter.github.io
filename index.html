<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Fling Game</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        .cat {
            cursor: grab;
        }
    </style>
</head>
<body>
<script>
    // Set up the SVG canvas
    let width = window.innerWidth;
    let height = window.innerHeight;

    const svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    // Load the cat image
    const catImageURL1 = "cat-image1.png";  
    const catImageURL2 = "cat-image2.png";  

    // Create an audio element for reuse
    const audio = new Audio("cat.mp3");  

    // Add a touchstart or mousedown event listener to authorize sound playback
    document.body.addEventListener('touchstart', () => {
        audio.play().catch(error => {
            console.log("Initial sound authorization failed or was prevented by the browser.");
        });
    }, { once: true });

    document.body.addEventListener('mousedown', () => {
        audio.play().catch(error => {
            console.log("Initial sound authorization failed or was prevented by the browser.");
        });
    }, { once: true });

    // Function to calculate cat size as 20% of the width
    function calculateCatSize() {
        return width * 0.2;
    }

    // Create the initial cat images side by side
    let catSize = calculateCatSize();

    let cat1 = svg.append("image")
        .attr("xlink:href", catImageURL1)
        .attr("width", catSize)
        .attr("height", catSize)
        .attr("x", width / 2 - catSize - 20)
        .attr("y", height - catSize)
        .attr("class", "cat")
        .call(dragBehavior(cat1StartX = width / 2 - catSize - 20, cat1StartY = height - catSize));

    let cat2 = svg.append("image")
        .attr("xlink:href", catImageURL2)
        .attr("width", catSize)
        .attr("height", catSize)
        .attr("x", width / 2 + 20)
        .attr("y", height - catSize)
        .attr("class", "cat")
        .call(dragBehavior(cat2StartX = width / 2 + 20, cat2StartY = height - catSize));

    // Define drag behavior
    function dragBehavior(startX, startY) {
        let initialX, initialY, velocityX, velocityY;

        return d3.drag()
            .on("start", function (event) {
                initialX = event.x;
                initialY = event.y;
                d3.select(this).style("cursor", "grabbing");
                playCuteSound();  // Play sound on start of drag
            })
            .on("drag", function (event) {
                d3.select(this).attr("x", event.x - catSize / 2).attr("y", event.y - catSize / 2);
            })
            .on("end", function (event) {
                velocityX = (event.x - initialX) * 2;  // Increase speed
                velocityY = (event.y - initialY) * 2;  // Increase speed
                flingCat(d3.select(this), velocityX, velocityY, startX, startY);
                d3.select(this).style("cursor", "grab");
            });
    }

    // Fling the cat image using a simple animation
    function flingCat(cat, vx, vy, startX, startY) {
        const duration = 1500;
        const t0 = Date.now();
        const x0 = parseFloat(cat.attr("x"));
        const y0 = parseFloat(cat.attr("y"));

        d3.timer(() => {
            const t = (Date.now() - t0) / duration;
            if (t > 1) {
                resetCat(cat, startX, startY);
                return true; // Stop the timer when done
            }

            const easeT = d3.easeCubicOut(t);
            const newX = x0 + vx * easeT;
            const newY = y0 + vy * easeT;
            const newSize = catSize * (1 - t);  // Reduce size as it moves away

            cat.attr("x", newX)
               .attr("y", newY)
               .attr("width", newSize)
               .attr("height", newSize);
        });
    }

    // Reset the cat to the starting position
    function resetCat(cat, startX, startY) {
        setTimeout(() => {
            cat.attr("x", startX)
               .attr("y", startY)
               .attr("width", catSize)
               .attr("height", catSize);
        }, 500);  // Add a delay before resetting
    }

    // Play a cute sound when the cat is touched
    function playCuteSound() {
        audio.currentTime = 0;  // Reset audio to the start
        audio.play().then(() => {
            console.log("Sound played successfully.");
        }).catch(error => {
            console.log("Sound playback failed or was prevented by the browser.");
        });
    }

    // Handle window resize
    window.addEventListener("resize", () => {
        width = window.innerWidth;
        height = window.innerHeight;
        catSize = calculateCatSize();

        svg.attr("width", width).attr("height", height);

        cat1.attr("width", catSize)
            .attr("height", catSize)
            .attr("x", width / 2 - catSize - 20)
            .attr("y", height - catSize);

        cat2.attr("width", catSize)
            .attr("height", catSize)
            .attr("x", width / 2 + 20)
            .attr("y", height - catSize);
    });
</script>
</body>
</html>
